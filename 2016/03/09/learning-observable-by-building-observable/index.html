<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>[译]做中学observable | 右领军大都督</title>
    <meta name="description" content="在最近的社交媒体、活动中，我常被问及关于“hot” vs “cold” observables的问题，或者observable到底是“multicast”还是“unicast”。人们似乎为Rx.Observable内部的黑魔法所困。当被要求介绍一下observable时，常听到“那就是些Stream”，或“就像是Promise”。而且，我本人也在各种场合的公开演讲中使用过这 ...">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/assets/css/0.styles.ff698ad4.css" as="style"><link rel="preload" href="/assets/js/app.66fd165c.js" as="script"><link rel="preload" href="/assets/js/6.1b9a181a.js" as="script"><link rel="preload" href="/assets/js/4.718a8abf.js" as="script"><link rel="preload" href="/assets/js/28.f0f1746b.js" as="script"><link rel="prefetch" href="/assets/js/1.836aefc7.js"><link rel="prefetch" href="/assets/js/10.5978e5d8.js"><link rel="prefetch" href="/assets/js/11.ec890499.js"><link rel="prefetch" href="/assets/js/12.db7bcb86.js"><link rel="prefetch" href="/assets/js/13.a0678d0c.js"><link rel="prefetch" href="/assets/js/14.db66846d.js"><link rel="prefetch" href="/assets/js/15.2591b2da.js"><link rel="prefetch" href="/assets/js/16.80583441.js"><link rel="prefetch" href="/assets/js/17.0753be43.js"><link rel="prefetch" href="/assets/js/18.72780206.js"><link rel="prefetch" href="/assets/js/19.1d487c74.js"><link rel="prefetch" href="/assets/js/20.f0fe9a95.js"><link rel="prefetch" href="/assets/js/21.d80a0f41.js"><link rel="prefetch" href="/assets/js/22.4695553f.js"><link rel="prefetch" href="/assets/js/23.52e4eec9.js"><link rel="prefetch" href="/assets/js/24.bf9c9350.js"><link rel="prefetch" href="/assets/js/25.5eb98d81.js"><link rel="prefetch" href="/assets/js/26.17cf0ede.js"><link rel="prefetch" href="/assets/js/27.522aaf5a.js"><link rel="prefetch" href="/assets/js/29.7185f335.js"><link rel="prefetch" href="/assets/js/30.84d20b8c.js"><link rel="prefetch" href="/assets/js/31.c51c0b21.js"><link rel="prefetch" href="/assets/js/32.7d842090.js"><link rel="prefetch" href="/assets/js/33.9948fc6c.js"><link rel="prefetch" href="/assets/js/34.03615f5c.js"><link rel="prefetch" href="/assets/js/35.916ec328.js"><link rel="prefetch" href="/assets/js/36.573317d5.js"><link rel="prefetch" href="/assets/js/37.766086c8.js"><link rel="prefetch" href="/assets/js/38.b2d6547e.js"><link rel="prefetch" href="/assets/js/39.f52d00bf.js"><link rel="prefetch" href="/assets/js/40.fffe6b1e.js"><link rel="prefetch" href="/assets/js/41.d2951850.js"><link rel="prefetch" href="/assets/js/42.1d2dcebb.js"><link rel="prefetch" href="/assets/js/43.8e48cd61.js"><link rel="prefetch" href="/assets/js/44.8303cf21.js"><link rel="prefetch" href="/assets/js/45.39ad8d71.js"><link rel="prefetch" href="/assets/js/5.6e87a095.js"><link rel="prefetch" href="/assets/js/7.01c41c5e.js"><link rel="prefetch" href="/assets/js/8.b9ecde8b.js"><link rel="prefetch" href="/assets/js/9.a3929d94.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.da6e1ebe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ff698ad4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">右领军大都督 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">右领军大都督 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        [译]做中学observable
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Howard Zuo</span> <span itemprop="address">   in Shanghai</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2016-03-09T00:00:00.000Z">
      Wed Mar 09 2016
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/tag/Rx" data-v-d832e844> Rx </a></li><li class="post-tag" data-v-d832e844><a href="/tag/Reactive Programming" data-v-d832e844> Reactive Programming </a></li><li class="post-tag" data-v-d832e844><a href="/tag/observable" data-v-d832e844> observable </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>在最近的社交媒体、活动中，我常被问及关于“hot” vs “cold” <code>observables</code>的问题，或者<code>observable</code>到底是“multicast”还是“unicast”。人们似乎为<code>Rx.Observable</code>内部的黑魔法所困。当被要求介绍一下<code>observable</code>时，常听到“那就是些<code>Stream</code>”，或“就像是<code>Promise</code>”。而且，我本人也在各种场合的公开演讲中使用过这类说辞。</p> <p>和<code>Promise</code>的比较是必然、但不准确的。假设<code>Promise</code>和<code>Observable</code>都是异步的，而且<code>Promises</code>已经被广泛使用、并且为JavaScript社区所熟知，这的确是个不错的切入点。拿<code>Promise</code>的<code>then</code>和<code>Observable</code>的<code>subscribe</code>做对比，看看<code>立即执行</code>和<code>延迟执行</code>的差异；看看撤销机制和复用机制。。。通过这些比较向初学者介绍<code>Observable</code>。</p> <p>但有个问题就是：<code>Observables</code>和<code>Promises</code>相比，差异大于相似。<code>Promise</code>永远是multicast。<code>Promise</code>的<code>resolution</code>和<code>rejection</code>永远是异步的。所以当人们开始以使用<code>Promise</code>的思维来处理<code>Observable</code>的代码时，所期待的结果并不都是成立的。<code>Observable</code>可能是multicast，可能是异步，但不代表全部情况。我开始有些自责关于之前人们对<code>Observable</code>认识不准确这件事上的推波助澜了。</p> <h3 id="observable就是一个函数，她接受一个observer作为参数然后返回另一个函数"><a href="#observable就是一个函数，她接受一个observer作为参数然后返回另一个函数" class="header-anchor">#</a> <code>Observable</code>就是一个函数，她接受一个<code>Observer</code>作为参数然后返回另一个函数</h3> <p>如果你真想了解<code>Observable</code>，最佳手段是自己写一个。说实话，也没有想象中那么难。一个<code>Observable</code>，说白了，就是一个有着特殊用途的函数。</p> <p>我们来看下她基本特征:</p> <ul><li>是个函数</li> <li>接受一个<code>Observer</code>(一个包含<code>next</code>、<code>error</code>和<code>complete</code>方法的对象)作为参数</li> <li>返回一个<code>unsubscribe</code>函数</li></ul> <p>再来看下她的目的：</p> <p>使<code>Observer</code>联通一个<code>Producer</code>，然后返回一个可以挂断与<code>Producer</code>联通关系的函数。<code>Observer</code>可被当作一个注册机处理程序。</p> <p>基本实现如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">myObservable</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> datasource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">ondata</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">oncomplete</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        datasource<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>(当然你也可以自己试试：<a href="http://jsbin.com/yazedu/1/edit?js,console,output" target="_blank" rel="noopener noreferrer">JSBin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p> <p>如你所见，也没多少内容，so easy！</p> <h3 id="safeobserver：写更好的observer"><a href="#safeobserver：写更好的observer" class="header-anchor">#</a> <code>SafeObserver</code>：写更好的<code>Observer</code></h3> <p>当我们讨论<code>RxJS</code>或者<code>Reactive Programming</code>时，<code>Observable</code>常常首先映入眼帘。但实际上，<code>Observer</code>才是那个干重活儿的人。<code>Observable</code>是懒汉，她就是一个函数，杵在那里等人<code>subscribe</code>，她加载好<code>Observer</code>，就结束任务，又百无聊赖等待被临幸了。另一方面，<code>Observer</code>一只保持活跃，不断从<code>Producer</code>那里接收消息。</p> <p>从现在起，你可以使用包含了<code>next</code>、<code>error</code>和<code>complete</code>方法的POJO(Plain-Old JavaScript Object)来subscribe <code>Observable</code>，但写区区一个POJO不过是开始。在<code>RxJS</code>5里，我们会提供一些保障机制给开发者，下面就是一些比较重要的保障原则：</p> <ol><li>传入的<code>Observer</code>对象可以不实现所有规定的方法</li> <li>在<code>complete</code>或者<code>error</code>触发之后再调用<code>next</code>方法是没用的</li> <li><code>unsubscribe</code>后，任何方法都不能再被调用了</li> <li><code>complete</code>和<code>error</code>触发后，<code>unsubscribe</code>也会自动调用</li> <li>当<code>next</code>、<code>complete</code>和<code>error</code>出现异常时，<code>unsubscribe</code>也会自动调用以保证资源不会溢出/浪费</li> <li><code>next</code>、<code>complete</code>和<code>error</code>是可选的。按需处理即可，不必全部处理。</li></ol> <p>为了完成上述目标，我们得把传入的匿名<code>Observer</code>对象封装在一个<code>SafeObserver</code>里以提供上述保障。例如第2项，我们要跟踪<code>complete</code>或<code>error</code>是否被调用。再比如第3项，我们得知道consumer什么时候要<code>unsubscribe</code>。最后，再看第4项，我们还得知道<code>unsubscribe</code>的逻辑，以便在<code>complete</code>或<code>error</code>之后帮用户完成<code>unsubscribe</code>操作。</p> <p>如果我们想对上面那个简陋的<code>Observable</code>进行安全性改造，代码一定变得和屎一样。不信可以自己到<a href="http://jsbin.com/kezejiy/2/edit?js,console,output" target="_blank" rel="noopener noreferrer">JSBin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>感受一下。我就不把那个鄙陋的实现放在这里了，文章显得太长没法读了。但我们还是可以看看，用了<code>SafeObserver</code>后，我们的<code>Observable</code>变成什么样儿了：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">myObservable</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> safeObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SafeObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> datasource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">ondata</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> safeObserver<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> safeObserver<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">oncomplete</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> safeObserver<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    safeObserver<span class="token punctuation">.</span><span class="token function-variable function">unsub</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        datasource<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> safeObserver<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>safeObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="改进observable：更好的safeobserver"><a href="#改进observable：更好的safeobserver" class="header-anchor">#</a> 改进<code>Observable</code>：更好的<code>SafeObserver</code></h3> <p>将<code>Observable</code>声明为class/object，让其接受一个函数作为构造器参数，这个函数以<code>SafeObserver</code>作为参数，以此向开发人员提供更友好的用法。因为在<code>Observable</code>的<code>subscribe</code>实现中控制了<code>SafeObserver</code>的创建过程，<code>Observable</code>可以书写成如下简单格式：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> myObservable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> datasource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">ondata</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datasource<span class="token punctuation">.</span><span class="token function-variable function">oncomplete</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        datasource<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>你会发现，上面的代码和我们第一次写的非常相似。但她更易于阅读和理解。我在之前的例子(<a href="http://jsbin.com/depeka/5/edit?js,console,output" target="_blank" rel="noopener noreferrer">JSBin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)里增加了最精简版本的<code>Observable</code>实现</p> <h3 id="operators：也是函数"><a href="#operators：也是函数" class="header-anchor">#</a> <code>Operators</code>：也是函数</h3> <p><code>Operator</code>在<code>RxJS</code>像是这样一种函数，她接收一个<code>Observable</code>，然后返回一个新的<code>Observable</code>，当<code>subscribe</code>返回的那个新的<code>Observable</code>时，她内部会自动<code>subscribe</code>前一个<code>Observable</code>。我们来简单实现一个独立的<code>Operator</code>，看这儿<a href="http://jsbin.com/xavaga/2/edit?js,console,output" target="_blank" rel="noopener noreferrer">JSBin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> project</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mapObserver <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">project</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> source<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>mapObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关于<code>Operator</code>最重要也最值得注意的是：当你<code>subscribe</code>她返回的的那个新的<code>Observable</code>时，她创建了一个<code>mapObserver</code>来做最终工作，并将其与前一个<code>Observer</code>链了起来。构建<code>Operator</code>链式结构，简单点说就是创建了一个模板在<code>Subscription</code>时把<code>Observers</code>链在一起。</p> <h3 id="改进observable：让operator的链式帅起来"><a href="#改进observable：让operator的链式帅起来" class="header-anchor">#</a> 改进<code>Observable</code>：让<code>Operator</code>的链式帅起来</h3> <p>如果把<code>Operator</code>都写成如上那种独立的函数，我们链式代码会逐渐变丑：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>myObservable<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在对着上面的代码，想象一下有5、6个嵌套着的<code>Operator</code>，再加上更多、更复杂的参数。基本上就没法儿看了</p> <p>你也可以试下<a href="https://twitter.com/AppShipIt/status/701806357012471809" target="_blank" rel="noopener noreferrer">Texas Toland<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提议的简单版管道实现，合并压缩一个数组的<code>Operator</code>并生成一个最终的<code>Observable</code>，不过这意味着要写更复杂的<code>Operator</code>，上代码：<a href="http://jsbin.com/vipuqiq/6/edit?js,console,output" target="_blank" rel="noopener noreferrer">JSBin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。其实写完后你会发现，代码也不怎么漂亮：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">pipe</span><span class="token punctuation">(</span>myObservable<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>理论上，我们想将代码用更自然的方式链起来：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>myObservable<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>所幸，我们已经有了这样一个<code>Observable</code>类，我们可以利用她在不增加复杂度的情况下完成多<code>Operators</code>的链式结构，不过之前的例子没有是用到牛逼的prototype，下面我们采用prototype方式再次实现一下<code>Observable</code>，(<a href="http://jsbin.com/quqibe/edit?js,console,output" target="_blank" rel="noopener noreferrer">JSBin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">Observable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">project</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mapObserver <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">project</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>mapObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>现在我们终于有了一个还不错的实现。这样实现还有其他好处，例如：可以写子类继承<code>Observable</code>(比方说：封装<code>Promise</code>或静态值)，然后在子类中重写某些内容以优化程序。</p> <h3 id="嫌长别看：observable就是函数，她接受observer作为参数，又返回一个函数"><a href="#嫌长别看：observable就是函数，她接受observer作为参数，又返回一个函数" class="header-anchor">#</a> 嫌长别看：<code>Observable</code>就是函数，她接受<code>Observer</code>作为参数，又返回一个函数</h3> <p>牢记，读完了上面所有内容，所有的设计都是基于一个简单函数。<code>Observable</code>就是函数，她接受<code>Observer</code>作为参数，又返回一个函数。再没别的了。如果你写了一个函数，接受一个<code>Observer</code>作为参数，又返回一个函数，那么，她是异步的、还是同步的？都不是。她就是个函数。任何函数的行为都依赖于她具体的实现内容。所以当你处理一个<code>Observable</code>时，就把她当成一个普通函数，里面没有什么黑魔法。当你要构建<code>Operator</code>链时，你做的其实就是生成一个函数将一堆<code>Observers</code>链在一起，然后让真正的数据依次穿过他们。</p> <blockquote><p>注意：上面我们给出的<code>Observable</code>实例实现依旧返回一个函数，但<code>RxJS</code>和<code>es-observable</code>返回的是<code>Subscription</code>对象。<code>Subscription</code>对象是更好的设计，但我恐怕得专门写篇关于她的文章。我在这里返回一个撤销订阅<code>unsubscribe</code>的函数仅仅是为了保持例子在一个简单易懂的范围。</p></blockquote> <p>原文地址：<a href="https://medium.com/@benlesh/learning-observable-by-building-observable-d5da57405d87#.7m5mee38d" target="_blank" rel="noopener noreferrer">Learning Observable By Building Observable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h3 active"><a href="#observable就是一个函数，她接受一个observer作为参数然后返回另一个函数" title="Observable就是一个函数，她接受一个Observer作为参数然后返回另一个函数">Observable就是一个函数，她接受一个Observer作为参数然后返回另一个函数</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#safeobserver：写更好的observer" title="SafeObserver：写更好的Observer">SafeObserver：写更好的Observer</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#改进observable：更好的safeobserver" title="改进Observable：更好的SafeObserver">改进Observable：更好的SafeObserver</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#operators：也是函数" title="Operators：也是函数">Operators：也是函数</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#改进observable：让operator的链式帅起来" title="改进Observable：让Operator的链式帅起来">改进Observable：让Operator的链式帅起来</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#嫌长别看：observable就是函数，她接受observer作为参数，又返回一个函数" title="嫌长别看：Observable就是函数，她接受Observer作为参数，又返回一个函数">嫌长别看：Observable就是函数，她接受Observer作为参数，又返回一个函数</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.66fd165c.js" defer></script><script src="/assets/js/6.1b9a181a.js" defer></script><script src="/assets/js/4.718a8abf.js" defer></script><script src="/assets/js/28.f0f1746b.js" defer></script>
  </body>
</html>
